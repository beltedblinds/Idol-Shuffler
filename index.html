<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Idol Gallery Shuffler</title>
  <style>
    :root{
      --bg:#0b0b0b; --card:#121212; --muted:#bbb;
      --accent:#1e90ff;
    }
    body{
      margin:0;
      font-family:system-ui,Segoe UI,Roboto,Arial;
      background:var(--bg);
      color:#fff;
      display:flex;
      flex-direction:column;
      align-items:center;
      min-height:100vh;
      padding:18px;
      box-sizing:border-box;
    }

    h1{ margin:6px 0 14px 0; font-size:20px; font-weight:600; }

    /* Controls above the image */
    .controls{
      display:flex;
      gap:8px;
      align-items:center;
      margin-bottom:14px;
      flex-wrap:wrap;
    }
    .btn{
      background:var(--card);
      color:#fff;
      border:1px solid #252525;
      padding:8px 12px;
      border-radius:8px;
      cursor:pointer;
      font-size:14px;
    }
    .btn:hover{ background:#1a1a1a; }

    /* Toggle style */
    .toggle {
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      background:var(--card);
      font-size:13px;
      cursor:pointer;
      user-select:none;
    }

    /* Image container */
    .image-wrapper{
      position:relative;
      max-width:92vw;
      max-height:78vh;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    #idolImage{
      max-width:100%;
      max-height:78vh;
      border-radius:10px;
      box-shadow:0 8px 30px rgba(0,0,0,0.6);
      background:#111;
      display:block;
    }

    /* Save icon (top-left of image) */
    #saveBtn{
      position:absolute;
      top:10px;
      left:10px;
      z-index:3;
      background:rgba(0,0,0,0.45);
      border:1px solid rgba(255,255,255,0.06);
      color:#fff;
      width:36px;
      height:36px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      font-size:16px;
      transition:background 0.15s;
    }
    #saveBtn.saved { color: var(--accent); background:rgba(30,144,255,0.2); }
    #saveBtn:hover{ background:rgba(30,144,255,0.16); color:var(--accent); }

    /* Saved thumbnails */
    #savedList{
      margin-top:18px;
      width:100%;
      max-width:920px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:center;
    }
    .saved-item{
      position:relative;
      width:96px;
      height:96px;
      border-radius:8px;
      overflow:hidden;
      cursor:pointer;
      border:1px solid #222;
      background:#111;
      display:inline-block;
    }
    .saved-item img{ width:100%; height:100%; object-fit:cover; display:block; }
    .saved-badge{
      position:absolute;
      top:6px;
      left:6px;
      background:rgba(0,0,0,0.6);
      padding:2px 6px;
      font-size:12px;
      border-radius:999px;
      color:#fff;
    }

    /* small label under image (folder) */
    #label {
      margin-top:10px;
      color:var(--muted);
      font-size:14px;
      min-height:18px;
    }

    @media (max-width:520px){
      .btn{ padding:8px; font-size:13px; }
      .saved-item{ width:72px; height:72px; }
    }
  </style>
</head>
<body>
  <h1>ðŸŽ´ Idol Gallery Shuffler</h1>

  <!-- Controls (above the image) -->
  <div class="controls" id="controls">
    <button class="btn" id="prevBtn">Previous</button>
    <button class="btn" id="randomBtn">Random</button>

    <div class="toggle btn" id="cycleToggle">
      <span id="cycleLabel">Cycle Off</span>
    </div>

    <div class="toggle btn" id="savedModeToggle">
      <span id="savedModeLabel">Saved Mode: Off</span>
    </div>
  </div>

  <!-- Image area -->
  <div class="image-wrapper" id="imageWrapper">
    <button id="saveBtn" title="Save/Unsave image">ðŸ’¾</button>
    <img id="idolImage" src="" alt="Idol" />
  </div>

  <div id="label"></div>

  <!-- Saved shortcuts -->
  <div id="savedList"></div>

<script>
const TXT_URL = "https://raw.githubusercontent.com/beltedblinds/idols-media-01/main/idol_gallery_links.txt";

let catalog = [];
let history = [];
let historyPos = -1;

let cycleId = null;
const CYCLE_MS = 7000;

let saved = [];
let savedMode = false;
let savedIndex = 0;

/* DOM */
const imgEl = document.getElementById("idolImage");
const labelEl = document.getElementById("label");
const savedListEl = document.getElementById("savedList");
const randomBtn = document.getElementById("randomBtn");
const prevBtn = document.getElementById("prevBtn");
const cycleToggle = document.getElementById("cycleToggle");
const cycleLabel = document.getElementById("cycleLabel");
const saveBtn = document.getElementById("saveBtn");
const savedModeToggle = document.getElementById("savedModeToggle");
const savedModeLabel = document.getElementById("savedModeLabel");

function parseCatalogText(text){
  const lines = text.split("\n").map(l => l.trim()).filter(Boolean);
  return lines.map(line => {
    const idx = line.indexOf(",");
    if(idx === -1) return null;
    const folder = line.slice(0, idx).trim();
    let url = line.slice(idx+1).trim().replace(/\/\.\//g, "/");
    return { folder, url };
  }).filter(Boolean);
}

function displayUrl(url, folder, pushHistory=true){
  if(!url) return;
  imgEl.src = url;
  labelEl.textContent = folder || "";
  saveBtn.classList.toggle("saved", !!saved.find(s => s.url === url));

  if(pushHistory){
    if(history.length === 0 || history[history.length-1] !== url){
      history.push(url);
      historyPos = history.length - 1;
    } else {
      historyPos = history.length - 1;
    }
  }
}

function showRandom(){
  if(savedMode){
    if(saved.length === 0) return;
    savedIndex = Math.floor(Math.random() * saved.length);
    displayUrl(saved[savedIndex].url, saved[savedIndex].folder, true);
  } else {
    if(catalog.length === 0) return;
    const i = Math.floor(Math.random() * catalog.length);
    displayUrl(catalog[i].url, catalog[i].folder, true);
  }
}

function showPrevious(){
  if(savedMode){
    if(saved.length === 0) return;
    savedIndex = (savedIndex - 1 + saved.length) % saved.length;
    displayUrl(saved[savedIndex].url, saved[savedIndex].folder, true);
  } else {
    if(historyPos > 0){
      historyPos--;
      const url = history[historyPos];
      const found = catalog.find(it => it.url === url);
      displayUrl(url, found ? found.folder : "", false);
    }
  }
}

function showNextSaved(){
  if(saved.length === 0) return;
  savedIndex = (savedIndex + 1) % saved.length;
  displayUrl(saved[savedIndex].url, saved[savedIndex].folder, true);
}

function startCycle(){
  if(cycleId) clearInterval(cycleId);
  cycleId = setInterval(() => showRandom(), CYCLE_MS);
  cycleLabel.textContent = "Cycle On";
}

function stopCycle(){
  if(cycleId) clearInterval(cycleId);
  cycleId = null;
  cycleLabel.textContent = "Cycle Off";
}

function toggleCycle(){
  if(cycleId) stopCycle(); else startCycle();
}

function toggleSavedMode(){
  savedMode = !savedMode;
  savedModeLabel.textContent = "Saved Mode: " + (savedMode ? "On" : "Off");
}

function loadSaved(){
  try{
    saved = JSON.parse(localStorage.getItem("idol_shuffler_saved_v1")) || [];
  }catch{ saved = []; }
  renderSaved();
}
function persistSaved(){
  localStorage.setItem("idol_shuffler_saved_v1", JSON.stringify(saved));
}
function renderSaved(){
  savedListEl.innerHTML = "";
  saved.forEach((it, idx) => {
    const wrap = document.createElement("div");
    wrap.className = "saved-item";
    const thumb = document.createElement("img");
    thumb.src = it.url;
    wrap.appendChild(thumb);
    const badge = document.createElement("div");
    badge.className = "saved-badge";
    badge.textContent = idx+1;
    wrap.appendChild(badge);
    wrap.addEventListener("click", () => {
      savedIndex = idx;
      displayUrl(it.url, it.folder, true);
    });
    savedListEl.appendChild(wrap);
  });
}

function saveCurrent(){
  const curUrl = imgEl.src;
  if(!curUrl) return;
  const found = catalog.find(it => it.url === curUrl);
  const existingIndex = saved.findIndex(s => s.url === curUrl);
  if(existingIndex !== -1){
    // unsave
    saved.splice(existingIndex, 1);
  } else {
    saved.push({ url: curUrl, folder: found ? found.folder : "" });
  }
  persistSaved();
  renderSaved();
  saveBtn.classList.toggle("saved", existingIndex === -1);
}

async function loadCatalog(){
  try{
    const r = await fetch(TXT_URL, { cache: "no-cache" });
    const txt = await r.text();
    catalog = parseCatalogText(txt);
    if(catalog.length === 0){
      labelEl.textContent = "No images found.";
      return;
    }
    showRandom();
  }catch(e){
    labelEl.textContent = "Error loading list.";
    console.error(e);
  }
}

/* Events */
randomBtn.addEventListener("click", showRandom);
prevBtn.addEventListener("click", showPrevious);
cycleToggle.addEventListener("click", toggleCycle);
savedModeToggle.addEventListener("click", toggleSavedMode);
saveBtn.addEventListener("click", saveCurrent);

window.addEventListener("keydown", (e) => {
  switch(e.key){
    case "ArrowLeft":
      e.preventDefault();
      if(savedMode) showPrevious(); else showPrevious();
      break;
    case "ArrowRight":
      e.preventDefault();
      if(savedMode) showNextSaved(); else showRandom();
      break;
    case "ArrowDown":
      e.preventDefault();
      saveCurrent();
      break;
    case "ArrowUp":
      e.preventDefault();
      toggleSavedMode();
      break;
  }
});

/* Init */
loadSaved();
loadCatalog();
</script>
</body>
</html>
